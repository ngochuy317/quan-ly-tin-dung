version: '3.4'

x-common-variables: &common-variables
  DJANGO_SETTINGS_MODULE: core.settings
  POSTGRES_USER: ${POSTGRES_USER}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  POSTGRES_DB: ${POSTGRES_DB}
  POSTGRES_HOST: ${POSTGRES_HOST}
  USE_SPACES: ${USE_SPACES}
  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
  AWS_STORAGE_BUCKET_NAME: ${AWS_STORAGE_BUCKET_NAME}
  AWS_S3_ENDPOINT_URL: ${AWS_S3_ENDPOINT_URL}
  SECRET_KEY: ${SECRET_KEY}
  DEBUG: ${DEBUG}

services:
  django-qltd:
    image: alan317/qltd-be:lastest
    container_name: django-qltd
    build:
      context: be
      dockerfile: ./be.Dockerfile
    environment: *common-variables
    ports:
      - '8000:8000'
    volumes:
      - ./be:/code
      - django-qltd_media:/code/media
      - django-qltd_volume:/code/staticfiles
    depends_on:
      - postgres
    networks:
      - django-qltd

  postgres:
    container_name: db-postgres-qltd
    restart: always
    image: postgres:13.3-alpine
    environment: *common-variables
    ports:
      - '5437:5432'
    volumes:
     - postgres_data_qltd:/var/lib/postgresql/data/
    networks:
      - django-qltd

  nginx:
    image: alan317/qltd-nginx:lastest
    container_name: nginx
    build:
      context: nginx
      dockerfile: ./nginx.Dockerfile
    ports:
      - 80:80
      - 443:443
    volumes:
      - django-qltd_volume:/var/www/mywebsite/backend/staticfiles
      - django-qltd_media:/var/www/mywebsite/backend/media
      - qltd_letsencrypt:/etc/letsencrypt/live/quanlyquetthe.com/fullchain.pem
      - qltd_certbot:/etc/letsencrypt/live/quanlyquetthe.com/privkey.pem
      - /var/log/nginx/:/var/log/nginx/

  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - qltd_letsencrypt:/etc/letsencrypt
      - qltd_certbot:/var/www/certbot
    command: certonly --webroot -w /var/www/certbot --force-renewal --email ngochuy317@gmail.com -d quanlyquetthe.com --agree-tos

  frontend:
    image: alan317/qltd-fe:lastest
    container_name: frontend
    build:
      context: ./fe_app
      args:
        REACT_APP_API_URL: http://165.22.102.193:8000/api
    ports:
      - '3000:80'
    volumes:
      - './frontend:/app'
      - '/app/node_modules'

volumes:
  django-qltd_media:
  django-qltd_volume:
  qltd_letsencrypt:
  qltd_certbot:
  postgres_data_qltd:

networks:
  django-qltd:
    external: true
